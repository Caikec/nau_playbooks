---
- name: Checks if required variables are available
  fail:
   msg: Please define the docker_swarm_manager and docker_swarm_worker (ansible groups)
  when: > 
    docker_swarm_manager is not defined or 
    docker_swarm_worker is not defined
  tags:
    - swarm
    - swarm-manager
    - swarm-worker

- name: Checks if docker is available
  stat:
    path: "{{ docker_path }}"
  register: stat_result
  tags:
    - swarm
    - swarm-manager
    - swarm-worker

- name: fail if docker not available
  fail:
    msg: "{{ docker_path }} is not available, please make sure docker is available"
  when: not stat_result.stat.exists
  tags:
    - swarm
    - swarm-manager
    - swarm-worker

- name: Install docker swarm pip dependencies
  pip:
    name: "{{ docker_swarm_pip_pkgs }}"
    state: present
  tags:
    - swarm
    - swarm-manager
    - swarm-worker
    - swarm-labels

- name: Gather facts from docker swarm managers and workers
  setup:
  delegate_to: "{{ item }}"
  delegate_facts: true
  when: item != inventory_hostname
  loop: "{{ docker_swarm_manager + docker_swarm_worker }}"
  tags:
    - swarm
    - swarm-manager
    - swarm-worker
    - swarm-labels

- name: Configures manager
  include_tasks: manager.yml
  when: inventory_hostname in docker_swarm_manager
  tags:
    - swarm
    - swarm-manager

- name: Configures workers
  include_tasks: worker.yml
  when: inventory_hostname in docker_swarm_worker
  tags:
    - swarm
    - swarm-worker

- name: Configures nodes labels
  include_tasks: labels.yml
  when: inventory_hostname == docker_swarm_manager[0] and ( configure_labels | default (true) )
  tags:
    - swarm
    - swarm-manager
    - swarm-worker
    - swarm-labels

- name: Removes cluster
  include_tasks: remove.yml
  when: remove_swarm_cluster|bool
  tags:
    - swarm-remove
