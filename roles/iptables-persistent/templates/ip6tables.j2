# ansible managed, do not edit manually.

*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:Chain-ICMP - [0:0]
:Chain-SYN - [0:0]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]

# Allow localhost communications
-A INPUT -i lo -j ACCEPT

# Accepth all established connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Ban Abusive IPs
{%if hostvars[inventory_hostname]['nau_firewall_ban_abusive_ipv6'] is defined %}
{% for ip in hostvars[inventory_hostname]['nau_firewall_ban_abusive_ipv6'] %}
-A INPUT -s {{ ip }} -j DROP
{% endfor %}
{% endif %}

# Detect ICMP FLOOD attacks and drop them
-A INPUT -p icmpv6 -j Chain-ICMP

# Detect TCP SYN FLOOD attacks
-A INPUT -p tcp --syn -j Chain-SYN -m comment --comment "Detect TCP SYN FLOOD attacks"

# Backups
-A INPUT -s 2001:690:A00:1036:0808::18,2001:690:A00:1036:0808::23 -m state --state NEW -m tcp -p tcp --dport 9102 -m comment --comment "Backups" -j ACCEPT

# Monitorization
-A INPUT -s 2001:690:a00:2029:0804::2 -m comment --comment "Monitorization Sirens" -j ACCEPT
-A INPUT -s 2001:690:a00:2029:2010::7 -m comment --comment "Monitorization Sirens bkp" -j ACCEPT
-A INPUT -s 2001:690:A00:F011::11 -m comment --comment "Monitorization Ananda" -j ACCEPT

# Rules to accept traffic from allowed networks
{% if (hostvars[inventory_hostname]['nau_firewall_allowed_tcp_ports'] is defined and hostvars[inventory_hostname]['nau_firewall_allowed_tcp_ports']|length>0 ) %}
{% if hostvars[inventory_hostname]['nau_firewall_allowed_all_networks'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -m multiport --dports {{ nau_firewall_allowed_tcp_ports | join(',') }} -j ACCEPT -m comment --comment "Accept {{ nau_firewall_allowed_tcp_ports | join(',') }} ports traffic"
{% else %}
{% for rule in hostvars[inventory_hostname]['nau_firewall_allowed_networks_ipv6'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -m multiport --dports {{ nau_firewall_allowed_tcp_ports | join(',') }} -s {{ rule.ip }} -j ACCEPT -m comment --comment "Accept {{ nau_firewall_allowed_tcp_ports | join(',') }} ports traffic from {{ rule.comment }} "
{% endfor %}

-I DOCKER-USER -j DROP -m comment --comment "Rule to DROP by default all incoming traffic to docker"
# Rules to accept traffic from allowed networks to DOCKER
{% for rule in hostvars[inventory_hostname]['nau_firewall_allowed_networks_ipv6'] %}
-I DOCKER-USER -s {{ rule.ip }} -j ACCEPT -m comment --comment "Accept from {{ rule.comment }} to DOCKER"
{% endfor %}
{% endif %}
{% endif %}

# Ban Abusive IPs
{%if hostvars[inventory_hostname]['nau_firewall_ban_abusive_ipv6'] is defined %}
{% for ip in hostvars[inventory_hostname]['nau_firewall_ban_abusive_ipv6'] %}
-I DOCKER-USER -s {{ ip }} -j DROP
{% endfor %}
{% endif %}

# Reject other traffic"
-A INPUT -m limit --limit 4/sec -j LOG --log-prefix "REJECT-UNKNOWN: " --log-level 7 --log-tcp-sequence --log-tcp-options --log-ip-options --log-uid -m comment --comment "Reject other traffic"
-A INPUT -j REJECT --reject-with icmp6-adm-prohibited -m comment --comment "Reject other traffic"

############
# CHAINS
############

# Detect ICMP FLOOD attacks and drop them
-A Chain-ICMP -m limit --limit 10/s --limit-burst 100 -j ACCEPT -m comment --comment "Detect ICMP FLOOD attacks and drop them"
-A Chain-ICMP -m limit --limit 4/s -j LOG --log-level 7 --log-prefix "DROP-ICMP-FLOOD: " --log-tcp-sequence --log-tcp-options --log-ip-options --log-uid -m comment --comment "Detect ICMP FLOOD attacks and drop them"
-A Chain-ICMP -j DROP -m comment --comment "Detect ICMP FLOOD attacks and drop them"

# Detect SYN FLOOD attacks and drop them
-A Chain-SYN -m limit --limit 200/s --limit-burst 200 -j RETURN -m comment --comment "Detect SYN FLOOD attacks and drop them"
-A Chain-SYN -m limit --limit 4/s -j LOG --log-level 7 --log-prefix "DROP-SYN-FLOOD: " --log-tcp-sequence --log-tcp-options --log-ip-options --log-uid -m comment --comment "Detect SYN FLOOD attacks and drop them"
-A Chain-SYN -j DROP -m comment --comment "Detect SYN FLOOD attacks and drop them"

# Custom iptables rules
{%if hostvars[inventory_hostname]['nau_firewall_custom_iptables_rules_ipv6'] is defined %}
{% for rule in hostvars[inventory_hostname]['nau_firewall_custom_iptables_rules_ipv6'] %}
{{ rule }}
{% endfor %}
{% endif %}

# Drop all other traffic.
-A INPUT -j DROP

COMMIT
