{% import '_docker_deploy_helper.j2' as helper with context %}
# {{ ansible_managed }}
#
# Docker compose file for mongo.
#
version: '3.8'

services:

  mongo:
    image: {{ mongo_docker_image }}
    container_name: {{ mongo_docker_container_name }}
    command: --replSet {{ MONGO_REPL_SET }} --bind_ip localhost,{{ mongo_docker_container_name }}
    restart: always
    environment:
      TZ: {{ mongo_timezone | default("Europe/Lisbon") }}
      MONGO_INITDB_ROOT_USERNAME_FILE: {{ mongo_docker_secret_root_username_file_path }}
      MONGO_INITDB_ROOT_PASSWORD_FILE: {{ mongo_docker_secret_root_password_file_path }}
    volumes:
      - {{ mongo_docker_volume_path }}:/data/db
    ports:
      - target: 27017
        published: {{ mongo_docker_published_port }}
        protocol: tcp
        mode: ingress
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 60s
      timeout: 50s
      retries: 10
      start_period: 30s
{{ helper.service_configs(service='mongo') }}
{{ helper.service_secrets(service='mongo') }}

{{ helper.configs() }}
{{ helper.secrets() }}
