---

- name: Create i18 directory
  file:
    path: "{{ i18n_root_dir }}"
    state: "directory"
    mode: '0755'
    owner: "{{ i18n_user }}"
    group: "{{ i18n_group }}"

- name: Install read-only ssh key
  copy:
    dest: "{{ i18n_root_dir }}/ssh_key"
    content: "{{ I18N_GIT_IDENTITY }}"
    owner: "{{ i18n_user }}"
    group: "{{ i18n_group }}"
    mode: "0600"
  no_log: True

- name: Update the repository
  git:
    repo: ssh://git@gitlab.fccn.pt/nau/nau_translations.git
    dest: "{{ i18n_repo_path }}"
    key_file: "{{ i18n_root_dir }}/ssh_key"
  register: git_pull
  when: nau_translations_update_repo is defined and nau_translations_update_repo == True

- name: Remove read-only ssh key
  file:
    dest: "{{ i18n_root_dir }}/ssh_key"
    state: absent
  no_log: True

- name: Get last commit message
  shell: git log -1
  args:
    chdir: "{{ i18n_repo_path }}"
  register: git_log
  when: nau_translations_update_repo is defined and nau_translations_update_repo == True

- name: Print the output of git updating and nau_translations_update_repo
  debug:
    var: git_log.stdout_lines
  when: nau_translations_update_repo is defined and nau_translations_update_repo == True

- name: Run the publish script from the project directory
  shell: "{{ i18n_repo_path }}/bin/publish_native"
  register: publish_output

- name: Print the output of publishing
  debug:
    var: publish_output.stdout_lines

