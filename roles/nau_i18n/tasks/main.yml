---

- name: Create i18 directory
  file:
    path: "{{ i18n_root_dir }}"
    state: "directory"
    mode: '0755'
    owner: "{{ i18n_user }}"
    group: "{{ i18n_group }}"
  tags: nau_i18n

- name: Install read-only ssh key
  copy:
    dest: "{{ i18n_root_dir }}/ssh_key"
    content: "{{ I18N_GIT_IDENTITY }}"
    owner: "{{ i18n_user }}"
    group: "{{ i18n_group }}"
    mode: "0600"
  no_log: True
  when: I18N_GIT_IDENTITY is defined
  tags: nau_i18n

- name: Update the repository
  git:
    repo: "{{ i18n_repo }}"
    dest: "{{ i18n_repo_path }}"
    key_file: "{{ i18n_root_dir }}/ssh_key"
    version: "{{ i18n_repo_version }}"
    accept_hostkey: yes
    force: true
  register: git_pull
  tags: nau_i18n

- name: Remove read-only ssh key
  file:
    dest: "{{ i18n_root_dir }}/ssh_key"
    state: absent
  no_log: True
  when: I18N_GIT_IDENTITY is defined
  tags: nau_i18n

- name: Get last commit message
  shell: git log -1
  args:
    chdir: "{{ i18n_repo_path }}"
  register: git_log
  tags: nau_i18n

- name: Print the output of git updating
  debug:
    var: git_log.stdout_lines
  tags: nau_i18n

- name: Run the publish script from the project directory
  shell: "{{ i18n_repo_path }}/bin/publish_native"
  register: publish_output
  tags: nau_i18n

- name: Print the output of publishing
  debug:
    var: publish_output.stdout_lines
  tags: nau_i18n

