# {{ ansible_managed }}

# This is the base file for the fluent bit.
# It overrides the default file on the container image, file link:
#   https://github.com/fluent/fluent-bit/blob/master/conf/fluent-bit.conf

[SERVICE]
    # Interval to flush output in seconds
    Flush            30
    Daemon           Off

    # Load parsers definition files
    # load the default parsers file, link: https://github.com/fluent/fluent-bit/blob/master/conf/parsers.conf
    Parsers_File     parsers.conf

    # Store streams and chunks of data in the filesystem.
    # If this parameter is not set, Input plugins can only use in-memory buffering.
    # So we don't lose any data if the fluentbit container needs to restart
    storage.path     /fluent-bit/data/storage

    # Next lines for test proposes.
    # To view the number of metrics processed run on each input, parser and output run the next cmd:
    #   curl -s http://127.0.0.1:2020/api/v1/metrics/ | jq<
    Log_Level        debug # info
    HTTP_Server      On
    # HTTP_Listen      0.0.0.0
    HTTP_Port        2020

# Forward is the protocol used by Fluent Bit and Fluentd to route messages between peers. 
# This plugin implements the input service to listen for Forward messages.
# The default docker daemon logging driver is the fluentd and the drive is configured
# in a way that each log message is tagged with the prefix `docker.container.log.` and then
# the docker container name. So the final `Tag` would be something like:
# `docker.container.log.<stack>_<service>.<slot>.<id>`.
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              {{ observability_fluentbit_relay_forward_port }}
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M
    Alias             docker_container_log

# Tail multiple docker host operating system log files and use a specific parser to proccess them.
[INPUT]
    Name           Tail
    Path           /var/log/auth.log
    Tag            auth
    Path_Key       log_file
    Parser         syslog-rfc3164
    Alias          log_auth

[INPUT]
    Name           Tail
    Path           /var/log/syslog
    Tag            syslog
    Path_Key       log_file
    Parser         syslog-rfc3164
    Alias          log_syslog

[INPUT]
    Name           Tail
    Path           /var/log/dpkg.log
    Tag            dpkg
    Path_Key       log_file
    Parser         syslog-rfc3164
    Alias          log_dpkg

[INPUT]
    Name           Tail
    Path           /var/log/mail.log
    Tag            mail
    Path_Key       log_file
    Parser         syslog-rfc3164
    Alias          log_mail

# The docker input plugin allows you to collect Docker container metrics such as memory usage and
# CPU consumption.
# [INPUT]
#     Name           docker
#     Tag            docker.metric

# The docker events input plugin uses the docker API to capture server events. 
# A complete list of possible events returned by this plugin can be found on
# https://docs.docker.com/engine/reference/commandline/events/
# [INPUT]
#     Name           docker_events
#     Tag            docker.event

# Prometheus Node Exporter is a popular way to collect system level metrics from 
# operating systems, such as CPU / Disk / Network / Process statistics. 
# Fluent Bit 1.8.0 includes node exporter metrics plugin that builds off the
# Prometheus design to collect system level metrics without having to manage
# two separate processes or agents.
# [INPUT]
#     Name            node_exporter_metrics
#     Tag             node_metrics
# # every 60 seconds
#     Scrape_interval 60
# #     # Inspired by:  https://github.com/fluent/fluent-bit/blob/master/docker_compose/node-exporter-dashboard/docker-compose.yml
#     Path.procfs     /host/proc
#     Path.sysfs      /host/sys
#     Alias           node_metrics

# Add the docker node hostname to the `host_name` new record from the environment variable 
# `DOCKER_NODE_HOSTNAME` to all the logs.
[FILTER]
    Name            record_modifier
    Match           *
    Record          host_name ${DOCKER_NODE_HOSTNAME}
    Alias           host_name

# Forward all messages to the aggretator fluentbit instance.
[OUTPUT]
    Name          forward
    Match         *
    Host          fluentbit-aggregator
    Port          {{ observability_fluentbit_aggregator_forward_port }}
    Alias         forward_to_aggregator

# Allow to view the messages using docker logs, only for test purposes.
[OUTPUT]
    Name            stdout
    Match           *
    # Match           openedx_lms*
# view only the openedx lms and cms container logs.
    # Match_Regex     openedx_(l|c)ms.*
    Alias raw_output
