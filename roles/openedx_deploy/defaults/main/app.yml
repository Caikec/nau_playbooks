---

openedx_app_image: nauedu/edxapp-prod:nau-lilac.master

# number of docker service replicas
openedx_lms_replicas: 1
openedx_cms_replicas: 1
openedx_lms_worker_replicas: 1
openedx_cms_worker_replicas: 1
openedx_smtp_replicas: 1

# number of workers that uwsgi has within each docker service
OPENEDX_LMS_UWSGI_WORKERS: 2
OPENEDX_CMS_UWSGI_WORKERS: 2

openedx_app_docker_deploy_templates:
  - src_data:  "{{ openedx_lms_env_file | to_nice_yaml(indent=2, width=1337) }}" # default_flow_style=False didn't work
    dest: "{{ openedx_docker_deploy_base_folder }}/app/lms.env.yml"
    service: edxapp
    config_name: lms_env
    docker_target: /openedx/config/lms.env.yml
  - src_data:  "{{ openedx_cms_env_file | to_nice_yaml(indent=2, width=1337) }}" # default_flow_style=False didn't work
    dest: "{{ openedx_docker_deploy_base_folder }}/app/studio.env.yml"
    service: edxapp
    config_name: studio_env
    docker_target: /openedx/config/cms.env.yml

openedx_app_docker_deploy_files:
  - src: files/app/nau_production.py
    dest: "{{ openedx_docker_deploy_base_folder }}/app/lms/envs/nau_production.py"
    service: edxapp
    config_name: lms_envs_nau_production
    docker_target: /openedx/edx-platform/lms/envs/nau_production.py
  - src: files/app/nau_production.py
    dest: "{{ openedx_docker_deploy_base_folder }}/app/cms/envs/nau_production.py"
    service: edxapp
    config_name: cms_envs_nau_production
    docker_target: /openedx/edx-platform/cms/envs/nau_production.py

# OPENEDX_TOP_DOMAIN:
OPENEDX_JWT_COMMON_ISSUER: "https://{{ OPENEDX_LMS_HOST }}/oauth2"
OPENEDX_LMS_HOST: "lms.{{ OPENEDX_TOP_DOMAIN }}"

# smtp ??
OPENEDX_SMTP_USER: ""
OPENEDX_SMTP_HOST: localhost
OPENEDX_SMTP_PORT: 25
OPENEDX_EMAIL_HOST_PASSWORD: ""
OPENEDX_SMTP_USE_TLS: false

openedx_smtp_external_host: ""
openedx_smtp_external_username: ""
openedx_smtp_external_password: "" # leave this blank to disable authentication

# redis
# use load balancer to use the right redis instance
OPENEDX_REDIS_HOST: load_balancer_haproxy
OPENEDX_REDIS_PORT: 6379
OPENEDX_REDIS_USERNAME: ""
OPENEDX_REDIS_PASSWORD: ""
OPENEDX_CELERY_REDIS_DB: 0
OPENEDX_CACHE_REDIS_DB: 1

OPENEDX_LANGUAGE_CODE: pt-PT
OPENEDX_SESSION_COOKIE_DOMAIN: ".{{ OPENEDX_LMS_HOST }}"

###################################
# Yaml reusable blocks
###################################

# Generic cache configuration so it can be reused bellow on both lms and studio
openedx_generic_cache_config: &default_openedx_generic_cache_config
  BACKEND: "django_redis.cache.RedisCache"
  LOCATION: "redis://{% if OPENEDX_REDIS_USERNAME and OPENEDX_REDIS_PASSWORD %}{{ OPENEDX_REDIS_USERNAME }}:{{ OPENEDX_REDIS_PASSWORD }}{% endif %}@{{ OPENEDX_REDIS_HOST }}:{{ OPENEDX_REDIS_PORT }}/{{ OPENEDX_CACHE_REDIS_DB }}"

edxapp_generic_contentstore_config: &edxapp_generic_default_contentstore
  ENGINE:  'xmodule.contentstore.mongo.MongoContentStore'
  #
  # connection strings are duplicated temporarily for
  # backward compatibility
  #
  OPTIONS:
    db: "{{ EDXAPP_MONGO_DB_NAME }}"
    host: "{{ EDXAPP_MONGO_HOSTS }}"
    password: "{{ EDXAPP_MONGO_PASSWORD }}"
    port: "{{ EDXAPP_MONGO_PORT }}"
    user: "{{ EDXAPP_MONGO_USER }}"
    ssl: "{{ EDXAPP_MONGO_USE_SSL }}"
    auth_source: "{{ EDXAPP_MONGO_AUTH_DB }}"

edxapp_generic_doc_store_config: &edxapp_generic_default_docstore
  db: "{{ EDXAPP_MONGO_DB_NAME }}"
  host: "{{ EDXAPP_MONGO_HOSTS }}"
  replicaSet: "{{ EDXAPP_MONGO_REPLICA_SET }}"
  password: "{{ EDXAPP_MONGO_PASSWORD }}"
  port: "{{ EDXAPP_MONGO_PORT }}"
  user: "{{ EDXAPP_MONGO_USER }}"
  collection:  'modulestore'
  ssl: "{{ EDXAPP_MONGO_USE_SSL }}"
  # https://api.mongodb.com/python/2.9.1/api/pymongo/mongo_client.html#module-pymongo.mongo_client
  socketTimeoutMS: 3000 # default is never timeout while the connection is open, this means it needs to explicitly close raising pymongo.errors.NetworkTimeout
  connectTimeoutMS: 2000 # default is 20000, I believe raises pymongo.errors.ConnectionFailure
  # Not setting waitQueueTimeoutMS and waitQueueMultiple since pymongo defaults to nobody being allowed to wait
  authsource: "{{ EDXAPP_MONGO_AUTH_DB }}"

edxapp_course_data_dir: /openedx/data/modulestore

#########################
# Old EDXAPP_ variables #
#########################
# that are shared between different environments
EDXAPP_ORA2_FILE_PREFIX: '{{ COMMON_ENVIRONMENT }}-{{ COMMON_DEPLOYMENT }}/ora2'
EDXAPP_RETIREMENT_STATES:
  - "PENDING"
  - "ERRORED"
  - "ABORTED"
  - "COMPLETE"

EDXAPP_VIDEO_IMAGE_SETTINGS:
    DIRECTORY_PREFIX: video-images/
    STORAGE_CLASS: storages.backends.s3boto.S3BotoStorage
    STORAGE_KWARGS:
        bucket: "{{ EDXAPP_AWS_STORAGE_BUCKET_NAME }}"
        host: "{{ nau_ceph_host }}"
        use_ssl: false
    VIDEO_IMAGE_MAX_BYTES: 2097152
    VIDEO_IMAGE_MIN_BYTES: 2048

EDXAPP_LMS_DRAFT_DOC_STORE_CONFIG:
  <<: *edxapp_generic_default_docstore
  read_preference: PRIMARY

EDXAPP_LMS_SPLIT_DOC_STORE_CONFIG:
  <<: *edxapp_generic_default_docstore
  read_preference: SECONDARY_PREFERRED

EDXAPP_CMS_DOC_STORE_CONFIG:
  <<: *edxapp_generic_default_docstore
  read_preference: PRIMARY

EDXAPP_MONGO_AUTH_DB: ''

EDXAPP_PLATFORM_DESCRIPTION: NAU Sempre a Aprender

###########################################
# bridge from OPENEDX to EDXAPP variables #
###########################################
OPENEDX_AWS_ACCESS_KEY: "{{ EDXAPP_AWS_ACCESS_KEY_ID }}"
OPENEDX_AWS_SECRET_ACCESS_KEY: "{{ EDXAPP_AWS_SECRET_ACCESS_KEY }}"

OPENEDX_LMS_HOST: "{{ EDXAPP_LMS_BASE }}"
OPENEDX_CMS_HOST: "{{ EDXAPP_CMS_BASE }}"
OPENEDX_SITE_NAME: "{{ EDXAPP_SITE_NAME }}"
OPENEDX_PLATFORM_NAME: "{{ EDXAPP_PLATFORM_NAME }}"
OPENEDX_PREVIEW_LMS_HOST: " {{ EDXAPP_PREVIEW_LMS_BASE }}"
OPENEDX_CONTACT_EMAIL: "{{ EDXAPP_CONTACT_EMAIL }}"
OPENEDX_EMAIL_HOST_PASSWORD: "{{ EDXAPP_EMAIL_HOST_PASSWORD }}"

openedx_smtp_external_host: "{{ POSTFIX_QUEUE_EXTERNAL_SMTP_HOST }}"
OPENEDX_CUSTOM_S3_HOST: "{{ nau_ceph_host }}"

OPENEDX_COURSE_CATALOG_API_URL: "{{ EDXAPP_COURSE_CATALOG_API_URL }}"
OPENEDX_CROSS_DOMAIN_CSRF_COOKIE_DOMAIN: "{{ EDXAPP_CROSS_DOMAIN_CSRF_COOKIE_DOMAIN }}"
OPENEDX_CROSS_DOMAIN_CSRF_COOKIE_NAME: "{{ EDXAPP_CROSS_DOMAIN_CSRF_COOKIE_NAME }}"
OPENEDX_CSRF_TRUSTED_ORIGINS: "{{ EDXAPP_CSRF_TRUSTED_ORIGINS }}"

#############################
# Common for LMS and STUDIO #
#############################
openedx_app_common_env_file: &openedx_app_common_env_file_reuse
  SECRET_KEY: "{{ EDXAPP_EDXAPP_SECRET_KEY }}"
  AWS_ACCESS_KEY_ID: "{{ OPENEDX_AWS_ACCESS_KEY }}"
  AWS_QUERYSTRING_AUTH: false
  AWS_S3_CUSTOM_DOMAIN: null
  AWS_S3_HOST: "{{ OPENEDX_CUSTOM_S3_HOST }}"
  AWS_SECRET_ACCESS_KEY: "{{ OPENEDX_AWS_SECRET_ACCESS_KEY }}"
  XQUEUE_INTERFACE:
    django_auth: null
    url: null
  DATABASES:
    default:
      ENGINE: "django.db.backends.mysql"
      HOST: mysql_1
      PORT: 3306
      NAME: "{{ EDXAPP_MYSQL_DB_NAME }}"
      USER: "{{ EDXAPP_MYSQL_USER }}"
      PASSWORD: "{{ EDXAPP_MYSQL_PASSWORD }}"
      ATOMIC_REQUESTS: true
      OPTIONS:
        init_command: "SET sql_mode='STRICT_TRANS_TABLES'"
    read_replica:
      ENGINE: "django.db.backends.mysql"
      HOST: mysql_2
      PORT: 3306
      NAME: "{{ EDXAPP_MYSQL_DB_NAME }}"
      USER: "{{ EDXAPP_MYSQL_USER }}"
      PASSWORD: "{{ EDXAPP_MYSQL_PASSWORD }}"
      ATOMIC_REQUESTS: true
      OPTIONS:
        init_command: "SET sql_mode='STRICT_TRANS_TABLES'"
  # smtp to send email configuration
  EMAIL_BACKEND: "django.core.mail.backends.smtp.EmailBackend"
  EMAIL_HOST: "{{ OPENEDX_SMTP_HOST }}"
  EMAIL_HOST_PASSWORD: "{{ OPENEDX_EMAIL_HOST_PASSWORD }}"
  EMAIL_PORT: "{{ OPENEDX_SMTP_PORT }}"
  EMAIL_USE_TLS: "{{ 'true' if OPENEDX_SMTP_USE_TLS else 'false' }}"
  
  # Application contact email
  CONTACT_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  BUGS_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  CONTACT_MAILING_ADDRESS: "{{ OPENEDX_CONTACT_EMAIL }}"
  DEFAULT_FEEDBACK_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  DEFAULT_FROM_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  FEEDBACK_SUBMISSION_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  TECH_SUPPORT_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  UNIVERSITY_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  PAYMENT_SUPPORT_EMAIL: "{{ OPENEDX_CONTACT_EMAIL }}"
  BULK_EMAIL_DEFAULT_FROM_EMAIL: "{{ EDXAPP_BULK_EMAIL_DEFAULT_FROM_EMAIL }}"

  BOOK_URL: ""
  LOG_DIR: "/openedx/data/logs"
  LOGGING_ENV: "sandbox"
  OAUTH_OIDC_ISSUER: "{{ OPENEDX_JWT_COMMON_ISSUER }}"
  PLATFORM_NAME: "{{ OPENEDX_PLATFORM_NAME }}"
  LMS_ROOT_URL: "https://{{ OPENEDX_LMS_HOST }}"
  CMS_ROOT_URL: "https://{{ OPENEDX_CMS_HOST }}"
  CMS_BASE: "{{ OPENEDX_CMS_HOST }}"
  LMS_BASE: "{{ OPENEDX_LMS_HOST }}"
  CELERY_BROKER_TRANSPORT: "redis"
  CELERY_BROKER_HOSTNAME: "{{ OPENEDX_REDIS_HOST }}:{{ OPENEDX_REDIS_PORT }}"
  CELERY_BROKER_VHOST: "{{ OPENEDX_CELERY_REDIS_DB }}"
  CELERY_BROKER_USER: "{{ OPENEDX_REDIS_USERNAME }}"
  CELERY_BROKER_PASSWORD: "{{ OPENEDX_REDIS_PASSWORD }}"
  ENABLE_COMPREHENSIVE_THEMING: true
  COMPREHENSIVE_THEME_DIRS: ["/openedx/themes"]
  STATIC_ROOT_BASE: "/openedx/staticfiles"
  ACE_ROUTING_KEY: "edx.lms.core.default"
  HTTPS: "on"
  LANGUAGE_CODE: "{{ OPENEDX_LANGUAGE_CODE }}"
  SESSION_COOKIE_DOMAIN: "{{ OPENEDX_SESSION_COOKIE_DOMAIN }}"

  # Temporary remove this until the image contains this requirement
  # ADDL_INSTALLED_APPS:
  #   - richie_openedx_sync
  AUTH_PASSWORD_VALIDATORS:
    - NAME: django.contrib.auth.password_validation.UserAttributeSimilarityValidator
    - NAME: util.password_policy_validators.MinimumLengthValidator
      OPTIONS:
          min_length: 8
    - NAME: util.password_policy_validators.MaximumLengthValidator
      OPTIONS:
          max_length: 75
    - NAME: util.password_policy_validators.UppercaseValidator
      OPTIONS:
          min_upper: 1
    - NAME: util.password_policy_validators.LowercaseValidator
      OPTIONS:
          min_lower: 1
    - NAME: util.password_policy_validators.NumericValidator
      OPTIONS:
          min_numeric: 1
    - NAME: util.password_policy_validators.PunctuationValidator
      OPTIONS:
          min_punctuation: 1
  CERTIFICATE_TEMPLATE_LANGUAGES:
      en: English
      pt: Português
  COMMENTS_SERVICE_KEY: "{{ FORUM_API_KEY }}"
  
  # env var ?
  CONTENTSTORE:
    <<: *edxapp_generic_default_contentstore
    ADDITIONAL_OPTIONS: "{{ EDXAPP_CONTENTSTORE_ADDITIONAL_OPTS | default( {} ) }}"
  
  COURSE_CATALOG_API_URL: "{{ OPENEDX_COURSE_CATALOG_API_URL }}"
  COURSE_MODE_DEFAULTS:
    bulk_sku: null
    currency: eur
    description: null
    expiration_datetime: null
    min_price: 0
    name: _('Honor')
    sku: null
    slug: honor
    suggested_prices: ''
  CROSS_DOMAIN_CSRF_COOKIE_DOMAIN: "{{ OPENEDX_CROSS_DOMAIN_CSRF_COOKIE_DOMAIN }}"
  CROSS_DOMAIN_CSRF_COOKIE_NAME: "{{ OPENEDX_CROSS_DOMAIN_CSRF_COOKIE_NAME }}"
  CSRF_TRUSTED_ORIGINS: "{{ OPENEDX_CSRF_TRUSTED_ORIGINS }}"
  DEFAULT_COURSE_LANGUAGE: pt
  DEFAULT_FILE_STORAGE: storages.backends.s3boto.S3BotoStorage
  DEFAULT_JWT_ISSUER:
    AUDIENCE: SET-ME-PLEASE
    ISSUER: https://{{ OPENEDX_LMS_HOST }}/oauth2
    SECRET_KEY: "{{ EDXAPP_JWT_SECRET_KEY }}"
  ECOMMERCE_API_SIGNING_KEY: "{{ EDXAPP_JWT_SECRET_KEY }}"
  ECOMMERCE_API_URL: "{{ EDXAPP_ECOMMERCE_API_URL }}"
  ECOMMERCE_PUBLIC_URL_ROOT: "{{ EDXAPP_ECOMMERCE_PUBLIC_URL_ROOT }}"
  EDXNOTES_INTERNAL_API: "{{ EDXAPP_EDXNOTES_INTERNAL_API }}"
  EDXNOTES_PUBLIC_API: "{{ EDXAPP_EDXNOTES_PUBLIC_API }}"
  EDX_API_KEY: "{{ EDXAPP_EDX_API_KEY }}"
  ENTERPRISE_API_URL: https://{{ OPENEDX_LMS_HOST }}/enterprise/api/v1
  ENTERPRISE_ENROLLMENT_API_URL: https://{{ OPENEDX_LMS_HOST }}/api/enrollment/v1/
  FACEBOOK_APP_ID: "{{ EDXAPP_FACEBOOK_APP_ID }}"
  FACEBOOK_APP_SECRET: "{{ EDXAPP_FACEBOOK_APP_SECRET }}"
  FEATURES:
    ACCESS_REQUIRE_STAFF_FOR_COURSE: false
    ADVANCED_SECURITY: true
    ALLOW_ALL_ADVANCED_COMPONENTS: true
    ALLOW_COURSE_STAFF_GRADE_DOWNLOADS: true
    ALLOW_HIDING_DISCUSSION_TAB: true
    ALLOW_PUBLIC_ACCOUNT_CREATION: true
    ALWAYS_REDIRECT_HOMEPAGE_TO_DASHBOARD_FOR_AUTHENTICATED_USER: false
    AUDIT_CERT_CUTOFF_DATE: None
    AUTH_USE_CAS: false
    AUTH_USE_CERTIFICATES: false
    AUTH_USE_OPENID: false
    AUTH_USE_OPENID_PROVIDER: false
    AUTH_USE_SHIB: false
    AUTOMATIC_AUTH_FOR_TESTING: false
    CERTIFICATES_ENABLED: true
    CERTIFICATES_HTML_VIEW: true
    CERTIFICATES_INSTRUCTOR_GENERATION: true
    COURSES_ARE_BROWSEABLE: true
    CSRF_COOKIE_SECURE: true
    CUSTOM_CERTIFICATE_TEMPLATES_ENABLED: true
    CUSTOM_COURSES_EDX: true
    DISABLE_LOGIN_BUTTON: false
    DISPLAY_DEBUG_INFO_TO_STAFF: true
    EMBARGO: false
    ENABLE_COMBINED_LOGIN_REGISTRATION: true
    ENABLE_COMBINED_LOGIN_REGISTRATION_FOOTER: true
    ENABLE_COOKIE_CONSENT: true
    ENABLE_CORS_HEADERS: true
    ENABLE_COSMETIC_DISPLAY_PRICE: false
    ENABLE_COUNTRY_ACCESS: false
    ENABLE_COURSEWARE_INDEX: true
    ENABLE_COURSEWARE_SEARCH: true
    ENABLE_COURSE_DISCOVERY: true
    ENABLE_CREATOR_GROUP: true
    ENABLE_CREDIT_API: false
    ENABLE_CREDIT_ELIGIBILITY: false
    ENABLE_CROSS_DOMAIN_CSRF_COOKIE: true
    ENABLE_CSMH_EXTENDED: false
    ENABLE_DASHBOARD_SEARCH: true
    ENABLE_DISABLING_XBLOCK_TYPES: true
    ENABLE_DISCUSSION_EMAIL_DIGEST: false
    ENABLE_DISCUSSION_HOME_PANEL: true
    ENABLE_DISCUSSION_SERVICE: true
    ENABLE_DJANGO_ADMIN_SITE: true
    ENABLE_EDXNOTES: true
    ENABLE_FEEDBACK_SUBMISSION: false
    ENABLE_GRADE_DOWNLOADS: true
    ENABLE_INSTRUCTOR_ANALYTICS: false
    ENABLE_INSTRUCTOR_BACKGROUND_TASKS: true
    ENABLE_INSTRUCTOR_EMAIL: true
    ENABLE_MANUAL_GIT_RELOAD: false
    ENABLE_MAX_FAILED_LOGIN_ATTEMPTS: true
    ENABLE_MAX_SCORE_CACHE: true
    ENABLE_MKTG_SITE: false
    ENABLE_MOBILE_REST_API: true
    ENABLE_OAUTH2_PROVIDER: true
    ENABLE_ONLOAD_BEACON: false
    ENABLE_OPENBADGES: false
    ENABLE_PAID_COURSE_REGISTRATION: false
    ENABLE_PEARSON_HACK_TEST: false
    ENABLE_PREREQUISITE_COURSES: true
    ENABLE_PUBLISHER: false
    ENABLE_READING_FROM_MULTIPLE_HISTORY_TABLES: true
    ENABLE_RENDER_XBLOCK_API: false
    ENABLE_SPECIAL_EXAMS: true
    ENABLE_STUDENT_HISTORY_VIEW: true
    ENABLE_STUDENT_NOTES: true
    ENABLE_SYSADMIN_DASHBOARD: false
    ENABLE_TEAMS: true
    ENABLE_TEXTBOOK: true
    ENABLE_THIRD_PARTY_AUTH: true
    ENABLE_VIDEO_BEACON: false
    ENABLE_VIDEO_BUMPER: false
    ENABLE_VIDEO_UPLOAD_PIPELINE: false
    ENABLE_XBLOCK_VIEW_ENDPOINT: true
    ENTRANCE_EXAMS: true
    INDIVIDUAL_DUE_DATES: true
    LICENSING: true
    LOG_POSTPAY_CALLBACKS: true
    MAX_ENROLLMENT_INSTR_BUTTONS: 500
    MILESTONES_APP: true
    ORGANIZATIONS_APP: true
    PREVENT_CONCURRENT_LOGINS: false
    PREVIEW_LMS_BASE: "{{ OPENEDX_PREVIEW_LMS_HOST }}"
    REQUIRE_COURSE_EMAIL_AUTH: false
    SHIB_DISABLE_TOS: false
    SHOW_FOOTER_LANGUAGE_SELECTOR: false
    SHOW_HEADER_LANGUAGE_SELECTOR: true
    SHOW_LANGUAGE_SELECTOR: false
    STORE_BILLING_INFO: false
    STUDIO_REQUEST_EMAIL: ''
    USE_DJANGO_PIPELINE: true
    USE_MICROSITES: false
  FEEDBACK_SUBMISSION_EMAIL: "{{ EDXAPP_FEEDBACK_SUBMISSION_EMAIL }}"
  FILE_UPLOAD_STORAGE_BUCKET_NAME: "{{ EDXAPP_FILE_UPLOAD_STORAGE_BUCKET_NAME | default(EDXAPP_AWS_STORAGE_BUCKET_NAME) }}"
  GRADES_DOWNLOAD:
    STORAGE_CLASS: "{{ EDXAPP_GRADE_STORAGE_CLASS | default(None) }}"
    STORAGE_KWARGS: "{{ EDXAPP_GRADE_STORAGE_KWARGS | default(None) }}"
    STORAGE_TYPE: "{{ EDXAPP_GRADE_STORAGE_TYPE | default(None) }}"
    BUCKET: "{{ EDXAPP_GRADE_BUCKET | default(None) }}"
    ROOT_PATH: "{{ EDXAPP_GRADE_ROOT_PATH | default(None) }}"
  # HTTPS: 'on'

  # env var ?
  JWT_COMMON_ISSUER: "{{ OPENEDX_JWT_COMMON_ISSUER }}"
  JWT_COMMON_SECRET_KEY: "{{ EDXAPP_JWT_SECRET_KEY }}"
  JWT_RSA_PRIVATE_KEY: "{{ EDXAPP_JWT_PRIVATE_SIGNING_JWK }}"
  
  # env var ?
  ELASTIC_SEARCH_CONFIG:
    - host: elasticsearch_1
      port: 9200
    - host: elasticsearch_2
      port: 9200
    - host: elasticsearch_3
      port: 9200
  
  LANGUAGES: "{{ EDXAPP_LANGUAGES }}"
  #LANGUAGE_COOKIE: "{{ EDXAPP_LANGUAGE_COOKIE }}"
  LEARNER_PORTAL_URL_ROOT: "https://learner-portal-{{ EDXAPP_LMS_BASE }}"
  LEARNING_MICROFRONTEND_URL: "{{ EDXAPP_LEARNING_MICROFRONTEND_URL }}"
  LMS_INTERNAL_ROOT_URL: "https://{{ OPENEDX_LMS_HOST }}"
  LOGIN_REDIRECT_WHITELIST: "{{ EDXAPP_LOGIN_REDIRECT_WHITELIST }}"
  MAINTENANCE_BANNER_TEXT: "{{ EDXAPP_MAINTENANCE_BANNER_TEXT }}"
  MKTG_URLS: "{{ EDXAPP_MKTG_URLS }}"
  OAUTH_ENFORCE_SECURE: true
  ORA2_FILE_PREFIX: "{{ EDXAPP_ORA2_FILE_PREFIX }}"
  PAID_COURSE_REGISTRATION_CURRENCY: "{{ EDXAPP_PAID_COURSE_REGISTRATION_CURRENCY }}"
  PLATFORM_DESCRIPTION: "{{ EDXAPP_PLATFORM_DESCRIPTION }}"
  PLATFORM_FACEBOOK_ACCOUNT: "{{ EDXAPP_PLATFORM_FACEBOOK_ACCOUNT }}"
  PLATFORM_TWITTER_ACCOUNT: "{{ EDXAPP_PLATFORM_TWITTER_ACCOUNT }}"
  PROFILE_IMAGE_BACKEND: "{{ EDXAPP_PROFILE_IMAGE_BACKEND }}"
  PROFILE_IMAGE_HASH_SEED: "{{ EDXAPP_PROFILE_IMAGE_SECRET_KEY }}"
  PROFILE_IMAGE_SECRET_KEY: "{{ EDXAPP_PROFILE_IMAGE_SECRET_KEY }}"
  REGISTRATION_EXTENSION_FORM: "nau_openedx_extensions.custom_registration_form.forms.NauUserExtendedForm"
  REGISTRATION_EXTRA_FIELDS:
    city: "required"
    confirm_email: "hidden"
    country: "required"
    gender: "optional"
    goals: "optional"
    honor_code: "required"
    level_of_education: "optional"
    mailing_address: "hidden"
    year_of_birth: "optional"
    terms_of_service: "hidden"
    data_authorization: "required"
    employment_situation: "optional"
    allow_newsletter: "optional"
    citizen_card: "hidden"
    nif: "hidden"
  REGISTRATION_FIELD_ORDER:
    - email
    - name
    - username
    - password
    - data_authorization
    - honor_code
    - city
    - country
    - allow_newsletter
    - gender
    - year_of_birth
    - level_of_education
    - employment_situation
    - goals
  RETIREMENT_STATES: "{{ EDXAPP_RETIREMENT_STATES }}"
  SESSION_COOKIE_NAME: "{{ EDXAPP_SESSION_COOKIE_NAME }}"
  SOCIAL_AUTH_OAUTH_SECRETS: "{{ EDXAPP_SOCIAL_AUTH_OAUTH_SECRETS }}"
  SOCIAL_AUTH_TPA_SAML_PIPELINE:
    - "third_party_auth.pipeline.parse_query_params"
    - "social_core.pipeline.social_auth.social_details"
    - "social_core.pipeline.social_auth.social_uid"
    - "social_core.pipeline.social_auth.auth_allowed"
    - "social_core.pipeline.social_auth.social_user"
    - "third_party_auth.pipeline.associate_by_email_if_login_api"
    - "social_core.pipeline.user.get_username"
    - "third_party_auth.pipeline.set_pipeline_timeout"
    - 'third_party_auth.pipeline.ensure_user_information'
    - "social_core.pipeline.user.create_user"
    - "social_core.pipeline.social_auth.associate_user"
    - "social_core.pipeline.social_auth.load_extra_data"
    - "social_core.pipeline.user.user_details"
    - "third_party_auth.pipeline.user_details_force_sync"
    - "third_party_auth.pipeline.set_id_verification_status"
    - "third_party_auth.pipeline.set_logged_in_cookies"
    - "third_party_auth.pipeline.login_analytics"
    - "nau_openedx_extensions.third_party_auth.pipeline.ensure_cartao_cidadao_data"
  SOCIAL_SHARING_SETTINGS: "{{ EDXAPP_SOCIAL_SHARING_SETTINGS }}"
  # Include more allowed fields for the LMS > Course > Instructor > student profile csv
  STUDENT_PROFILE_DOWNLOAD_FIELDS_CUSTOM_STUDENT_ATTRIBUTES:
    - nau_user_extended_model_cc_nic
    - nau_nif
    - nau_user_extended_model_employment_situation
  SUPPORT_SITE_LINK: "{{ EDXAPP_SUPPORT_SITE_LINK }}"
  TIME_ZONE: "{{ EDXAPP_TIME_ZONE }}"
  VIDEO_TRANSCRIPTS_SETTINGS: "{{ EDXAPP_VIDEO_TRANSCRIPTS_SETTINGS }}"

  # Django media url configuration
  MEDIA_URL: /media/

  VIDEO_IMAGE_SETTINGS: "{{ EDXAPP_VIDEO_IMAGE_SETTINGS }}"

  DJFS: "{{ EDXAPP_DJFS }}"


##################
# LMS
##################
# container lms and lms-worker environment variables
openedx_lms_env_var: "{{ openedx_lms_env_var_default | combine(openedx_lms_env_var_overrides, recursive=True) }}"
openedx_lms_env_var_overrides: {}
openedx_lms_env_var_default:
  SERVICE_VARIANT: lms
  SETTINGS: nau_production
  LMS_CFG: /openedx/config/lms.env.yml
  UWSGI_WORKERS: "{{ OPENEDX_LMS_UWSGI_WORKERS }}"
  # Use custom timezone
  TZ: "{{ openedx_timezone | default('Europe/Lisbon') }}"

# lms env yaml file
openedx_lms_env_file: "{{ openedx_app_common_env_file | combine(openedx_lms_env_file_default, recursive=True) | combine(openedx_lms_env_file_overrides, recursive=True) }}"
openedx_lms_env_file_overrides: {}
openedx_lms_env_file_default:
  # <<: *openedx_app_common_env_file_reuse
  SITE_NAME: "{{ OPENEDX_SITE_NAME }}"
  ALTERNATE_WORKER_QUEUES: "cms"
  CACHES:
    default:
      KEY_PREFIX: "default"
      VERSION: "1"
      <<: *default_openedx_generic_cache_config
    general:
      KEY_PREFIX: "general"
      <<: *default_openedx_generic_cache_config
    mongo_metadata_inheritance:
      KEY_PREFIX: "mongo_metadata_inheritance"
      TIMEOUT: 300
      <<: *default_openedx_generic_cache_config
    staticfiles:
      KEY_PREFIX: "staticfiles_lms"
      BACKEND: "django.core.cache.backends.locmem.LocMemCache"
      LOCATION: "staticfiles_lms"
    configuration:
      KEY_PREFIX: "configuration"
      <<: *default_openedx_generic_cache_config
    celery:
      KEY_PREFIX: "celery"
      TIMEOUT: "7200"
      <<: *default_openedx_generic_cache_config
    course_structure_cache:
      KEY_PREFIX: "course_structure"
      TIMEOUT: "7200"
      <<: *default_openedx_generic_cache_config
    ora2-storage:
      KEY_PREFIX: "ora2-storage"
      <<: *default_openedx_generic_cache_config
  # MongoDB
  CONTENTSTORE:
    DOC_STORE_CONFIG: "{{ EDXAPP_LMS_SPLIT_DOC_STORE_CONFIG }}"
  DOC_STORE_CONFIG: "{{ EDXAPP_LMS_SPLIT_DOC_STORE_CONFIG }}"
  MODULESTORE:
    default:
        ENGINE: 'xmodule.modulestore.mixed.MixedModuleStore'
        OPTIONS:
          mappings: {}
          stores:
            - NAME: 'split'
              ENGINE: 'xmodule.modulestore.split_mongo.split_draft.DraftVersioningModuleStore'
              DOC_STORE_CONFIG: "{{ EDXAPP_LMS_SPLIT_DOC_STORE_CONFIG }}"
              OPTIONS:
                default_class: 'xmodule.hidden_module.HiddenDescriptor'
                fs_root:  "{{ edxapp_course_data_dir }}"
                render_template: 'common.djangoapps.edxmako.shortcuts.render_to_string'
            - NAME: 'draft'
              ENGINE: 'xmodule.modulestore.mongo.DraftMongoModuleStore'
              DOC_STORE_CONFIG: "{{ EDXAPP_LMS_DRAFT_DOC_STORE_CONFIG }}"
              OPTIONS:
                default_class: 'xmodule.hidden_module.HiddenDescriptor'
                fs_root:  "{{ edxapp_course_data_dir }}"
                render_template: 'common.djangoapps.edxmako.shortcuts.render_to_string'

#######################################
# LMS Worker - that run Celery tasks
#######################################
openedx_lms_worker_env_var: "{{ openedx_lms_env_var  | combine(openedx_lms_worker_env_var_default, recursive=True) | combine(openedx_lms_worker_env_var_overrides, recursive=True) }}"

openedx_lms_worker_env_var_default:
  C_FORCE_ROOT: "1" # run celery tasks as root #nofear

# per environment lms-worker environment variables
openedx_lms_worker_env_var_overrides: {}

##################
# CMS / Studio
##################
# container cms and cms-worker environment variables
openedx_cms_env_var: "{{ openedx_cms_env_var_default | combine(openedx_cms_env_var_overrides, recursive=True) }}"
openedx_cms_env_var_overrides: {}
openedx_cms_env_var_default:
  SERVICE_VARIANT: cms
  SETTINGS: nau_production
  STUDIO_CFG: /openedx/config/cms.env.yml
  UWSGI_WORKERS: "{{ OPENEDX_CMS_UWSGI_WORKERS }}"
  # Use custom timezone
  TZ: "{{ openedx_timezone | default('Europe/Lisbon') }}"

# cms/studio yaml env file
openedx_cms_env_file: "{{ openedx_app_common_env_file | combine(openedx_cms_env_file_default, recursive=True) | combine(openedx_cms_env_file_overrides, recursive=True) }}"
openedx_cms_env_file_overrides: {}
openedx_cms_env_file_default:
  # <<: *openedx_app_common_env_file_reuse
  SITE_NAME: "{{ EDXAPP_CMS_SITE_NAME }}"
  ALTERNATE_WORKER_QUEUES: "lms"
  CACHES:
    default:
      KEY_PREFIX: "default"
      VERSION: "1"
      <<: *default_openedx_generic_cache_config
    general:
      KEY_PREFIX: "general"
      <<: *default_openedx_generic_cache_config
    mongo_metadata_inheritance:
      KEY_PREFIX: "mongo_metadata_inheritance"
      TIMEOUT: 300
      <<: *default_openedx_generic_cache_config
    staticfiles:
      KEY_PREFIX: "staticfiles_cms"
      BACKEND: "django.core.cache.backends.locmem.LocMemCache"
      LOCATION: "staticfiles_cms"
    configuration:
      KEY_PREFIX: "configuration"
      <<: *default_openedx_generic_cache_config
    celery:
      KEY_PREFIX: "celery"
      TIMEOUT: "7200"
      <<: *default_openedx_generic_cache_config
    course_structure_cache:
      KEY_PREFIX: "course_structure"
      TIMEOUT: "7200"
      <<: *default_openedx_generic_cache_config
    ora2-storage:
      KEY_PREFIX: "ora2-storage"
      <<: *default_openedx_generic_cache_config
  # MongoDB
  CONTENTSTORE:
    DOC_STORE_CONFIG: "{{ EDXAPP_CMS_DOC_STORE_CONFIG }}"
  DOC_STORE_CONFIG: "{{ EDXAPP_CMS_DOC_STORE_CONFIG }}"
  MODULESTORE:
    default:
        ENGINE: 'xmodule.modulestore.mixed.MixedModuleStore'
        OPTIONS:
          mappings: {}
          stores:
            - NAME: 'split'
              ENGINE: 'xmodule.modulestore.split_mongo.split_draft.DraftVersioningModuleStore'
              DOC_STORE_CONFIG: "{{ EDXAPP_CMS_DOC_STORE_CONFIG }}"
              OPTIONS:
                default_class: 'xmodule.hidden_module.HiddenDescriptor'
                fs_root:  "{{ edxapp_course_data_dir }}"
                render_template: 'common.djangoapps.edxmako.shortcuts.render_to_string'
            - NAME: 'draft'
              ENGINE: 'xmodule.modulestore.mongo.DraftMongoModuleStore'
              DOC_STORE_CONFIG: "{{ EDXAPP_CMS_DOC_STORE_CONFIG }}"
              OPTIONS:
                default_class: 'xmodule.hidden_module.HiddenDescriptor'
                fs_root:  "{{ edxapp_course_data_dir }}"
                render_template: 'common.djangoapps.edxmako.shortcuts.render_to_string'

#######################################
# CMS Worker - that run Celery tasks
#######################################
openedx_cms_worker_env_var: "{{ openedx_cms_env_var  | combine(openedx_cms_worker_env_var_default, recursive=True) | combine(openedx_cms_worker_env_var_overrides, recursive=True) }}"

openedx_cms_worker_env_var_default:
  C_FORCE_ROOT: "1" # run celery tasks as root #nofear

# per environment cms-worker environment variables
openedx_cms_worker_env_var_overrides: {}
