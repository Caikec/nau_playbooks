# {{ ansible_managed }}

global
    log stdout format raw daemon            # send everything to stdout
    log stderr format raw daemon notice     # send important events to stderr
    # allows to reload the HAProxy configuration without needing to restart the container itself
    master-worker

defaults
    option  dontlognull
    timeout connect 5s
    
    # By default linux kernel send keep-alive packages only after a connection is idle for more
    # than 2 hours, so we increase the haproxy client timeout to 3 hours and enable the sending
    # of TCP keepalive packets on the client side. We are enabling this feature to all listen and
    # frontends bellow because this HAProxy instance is to be used inside the backend services.
    # If this is going to be used by browser clients we should use lower client timeout.
    #   cat /proc/sys/net/ipv4/tcp_keepalive_time
    # https://serverfault.com/questions/589804/haproxy-configuration-for-rabbitmq/652326#652326
    timeout client  3h

    # Enable the sending of TCP keepalive packets on the client side
    option  clitcpka
    
    # Sets the time between individual keepalive probes on the client side.
    option clitcpka-intvl 15m

    # Enable the sending of TCP keepalive packets on the server side
    option  srvtcpka 
    
    # Sets the time between individual keepalive probes on the server side
    option srvtcpka-intvl 15m

    # Set the maximum time for pending data staying into output buffer
    timeout server  3h

    # Set the maximum inactivity time on the client and server side for tunnels.
    # timeout tunnel  4h

    timeout check   10s
    option  redispatch
    option  http-server-close

    # never fail on address resolution
    default-server init-addr last,libc,none

    log global


# If the MySQL containers restarts then its IP address whould change.
# The HAProxy by default does not resolve the DNS again until a restart.
# To fix this we need to specify the next `resolvers` HaProxy configuration and use the `resolvers`
# on the server line.
resolvers docker_resolver
    # Adds all nameservers found in /etc/resolv.conf to this resolvers nameservers list
    parse-resolv-conf
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    hold obsolete   10s

# haproxy statistics page
frontend stats
    bind *:{{ openedx_haproxy_statistics_port }}
    mode http
    stats enable
    stats uri / # show stats on homepage
    stats refresh 60s

{% for mysql_container_name, mysql_container in openedx_mysql_containers.items() %}
# Not a real balancing, just a method to publish an ingress port to a container that is configured using dnsrr
listen {{ mysql_container_name }}
    bind *:{{ mysql_container.outside_port }}
    mode tcp
    server {{ mysql_container_name }} {{ mysql_container.hostname }}:3306 resolvers docker_resolver

{% endfor %}

# Primary port for writes and reads
# Uses primary servers and only if not available uses the secondary
listen mysql_haproxy_write
    bind *:{{ openedx_haproxy_write_port | default(3306) }}
    mode tcp
    option mysql-check user {{ openedx_haproxy_health_check_user }}
{% for mysql_container_name, mysql_container in openedx_mysql_containers.items() %}
    server {{ mysql_container_name }} {{ mysql_container.hostname }}:3306 check on-marked-down shutdown-sessions on-marked-up shutdown-backup-sessions inter 10s fastinter 5s downinter 2s resolvers docker_resolver {{ "backup" if not mysql_container.primary else "" }}
{% endfor %}

# Secondary por only for reads
# Uses secondary/replica server by default, if not available uses the primary
listen mysql_haproxy_readonly
    bind *:{{ openedx_haproxy_readonly_port | default(3307) }}
    mode tcp
    option mysql-check user {{ openedx_haproxy_health_check_user }}
{% for mysql_container_name, mysql_container in openedx_mysql_containers.items() %}
    server {{ mysql_container_name }} {{ mysql_container.hostname }}:3306 check on-marked-down shutdown-sessions on-marked-up shutdown-backup-sessions inter 10s fastinter 5s downinter 2s resolvers docker_resolver {{ "backup" if mysql_container.primary else "" }}
{% endfor %}

# Connects to any elasticsearch node server
listen elasticsearch
    bind *:9200
    mode http
{% for container, config in openedx_elasticsearch_containers.items() %}
    server {{ container }} {{ openedx_docker_deploy_stack_name }}_{{ container }}:9200 check on-marked-down shutdown-sessions on-marked-up shutdown-backup-sessions inter 10s fastinter 5s downinter 2s resolvers docker_resolver{{ " backup" if loop.index > 1 else "" }}
{% endfor %}

# Active-passive redis primary.
# If redis primary on cluster 1 down use primary on cluster 2.
listen redis_primary
    bind *:{{ openedx_haproxy_redis_port }}
    mode tcp
    option tcp-check
    tcp-check connect
    #uncomment these lines if you have basic auth
    # tcp-check send AUTH\ MYPASSWORD\r\n
    # tcp-check expect string +OK
    tcp-check send PING\r\n
    tcp-check expect string +PONG
    tcp-check send info\ replication\r\n
    tcp-check expect string role:master
    tcp-check send QUIT\r\n
    tcp-check expect string +OK

{% for container, config in openedx_redis_containers.items() %}
    server {{ docker_deploy_stack_name }}_{{ container }} {{ docker_deploy_stack_name }}_{{ container }}:6379 check on-marked-down shutdown-sessions on-marked-up shutdown-backup-sessions inter 2s resolvers docker_resolver{{ " backup" if loop.index > 1 else "" }}
{% endfor %}

