---
# Remove old containers that this stack no longer use
staticproxy_docker_deploy_stack_prune: true

staticproxy_docker_deploy_stack_name: staticproxy
staticproxy_docker_deploy_stack_template: templates/docker-stack.yml
staticproxy_docker_deploy_base_folder: /nau/ops/staticproxy

staticproxy_docker_deploy_templates:
  - src: "{{ staticproxy_makefile_template | default('templates/Makefile') }}"
    dest: "{{ staticproxy_docker_deploy_base_folder }}/Makefile"
  - src: "{{ staticproxy_nginx_conf_template | default('templates/nginx.conf') }}"
    dest: "{{ staticproxy_docker_deploy_base_folder }}/nginx/nginx.conf"
    docker_target: /etc/nginx/nginx.conf
    config_name: nginx_conf
    service: nginx

staticproxy_nginx_ssl_certificate_folder: "{{ COMMON_PATH_CUSTOM_FILES }}/static/nginx/ssl"
staticproxy_nginx_proxy_protocol: false
staticproxy_nginx_http2: true
staticproxy_nginx_image: nginx:1.20.2
staticproxy_nginx_http_ingress_port:  22080
staticproxy_nginx_https_ingress_port: 22443
staticproxy_nginx_replicas: 1

staticproxy_docker_deploy_files:
  - src: "{{ staticproxy_nginx_ssl_certificate_key }}"
    dest: "{{ staticproxy_docker_deploy_base_folder }}/nginx/ssl/certificate.key.pem"
    docker_target: /etc/ssl/certs/certificate.key.pem
    secret_name: certificate_key
    service: nginx
  - src: "{{ staticproxy_nginx_ssl_certificate_crt }}"
    dest: "{{ staticproxy_docker_deploy_base_folder }}/nginx/ssl/certificate.crt.pem"
    docker_target: /etc/ssl/certs/certificate.crt.pem
    secret_name: certificate_crt
    service: nginx

# Nginx is only a reverse proxy to reach the buckets that need public access with or without signature
staticproxy_nginx_servers: "{{ staticproxy_nginx_servers_default }}"
staticproxy_nginx_servers_default:
  - name: "shared.{{ nau_ceph_host_public }}"
    proxy_pass: "{{ nau_ceph_host }}/{{ NAU_SHARED_BUCKET }}/"
  - name: "{{ EDXAPP_GRADE_BUCKET }}.{{ nau_ceph_host_public }}"
    proxy_pass: "{{ nau_ceph_host }}/{{ EDXAPP_GRADE_BUCKET }}/"
  - name: "profile-pictures.{{ nau_ceph_host_public}}"
    proxy_pass: "{{ nau_ceph_host }}/{{ NAU_PROFILE_IMAGE_BUCKET }}/"
  - name: "uploads.{{ nau_ceph_host_public }}"
    proxy_pass: "{{ nau_ceph_host }}/{{ EDXAPP_AWS_STORAGE_BUCKET_NAME }}/"
  - name: "{{ EDXAPP_IMPORT_EXPORT_BUCKET }}.{{ nau_ceph_host_public }}"
    proxy_pass: "{{ nau_ceph_host }}/{{ EDXAPP_IMPORT_EXPORT_BUCKET }}/"
  - name: "{{ EDXAPP_AWS_STORAGE_BUCKET_NAME }}.{{ nau_ceph_host_public }}"
    proxy_pass: "{{ nau_ceph_host }}/{{ EDXAPP_AWS_STORAGE_BUCKET_NAME }}/"
  - name: "{{ RICHIE_NAU_AWS_BUCKET_NAME }}.{{ nau_ceph_host_public }}"
    proxy_pass: "{{ nau_ceph_host }}/{{ RICHIE_NAU_AWS_BUCKET_NAME }}/"

# List of URLs to check during deployment.
staticproxy_nau_urls_to_check:
  - name: staticproxy maintenance page
    host: "shared.{{ nau_ceph_host_public }}"
    protocol: https
    page: maintenance-site/index.html
    content: ajuda@nau.edu.pt
    retries: 5
    port: "{{ staticproxy_nginx_https_ingress_port }}"
